<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>MESSMATE ‚Äî Simsang Hostel Mess</title>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<link rel="stylesheet" href="style.css"/>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&display=swap" rel="stylesheet">
</head>

<body>

<!-- Animated Background -->
<div class="bg-animation">
    <div class="shape shape-1"></div>
    <div class="shape shape-2"></div>
    <div class="shape shape-3"></div>
</div>

<!-- ========== SITE HEADER ========== -->
<header class="site-header">
    <div class="brand">
        <div class="logo">
            <span class="logo-icon">üçΩÔ∏è</span>
        </div>
        <div class="brand-text">
            <h1>MESSMATE</h1>
            <p class="subtitle">Simsang Hostel ‚Ä¢ Weekly Menu & Feedback System</p>
        </div>
    </div>
    <div class="header-actions">
        <a href="admin/login.php" class="admin-btn" target="_blank">
            <span>‚öôÔ∏è</span> Admin Portal
        </a>
    </div>
</header>

<!-- ========== NOTIFICATION BANNERS ========== -->
<!-- TODAY'S MENU NOTIFICATION BANNER -->
<div class="notification-banner" id="todayMenuBanner">
    <div class="banner-content">
        <span class="banner-icon">üçΩÔ∏è</span>
        <div class="banner-text">
            <strong>Today's Menu:</strong>
            <span id="todayMenuText">Loading...</span>
        </div>
        <button class="banner-close" onclick="closeBanner('todayMenuBanner')">‚úï</button>
    </div>
</div>

<!-- FEEDBACK STATUS NOTIFICATION BANNER -->
<div class="notification-banner feedback-notification" id="feedbackBanner" style="display: none;">
    <div class="banner-content">
        <span class="banner-icon">üí¨</span>
        <div class="banner-text">
            <strong id="feedbackStatusTitle">Feedback Update</strong>
            <span id="feedbackStatusText"></span>
        </div>
        <span class="new-badge">NEW</span>
        <button class="banner-close" onclick="closeBanner('feedbackBanner')">‚úï</button>
    </div>
</div>

<!-- ========== NAVIGATION BAR ========== -->
<nav class="navbar">
    <div class="nav-wrapper">
        <button class="nav-item active" data-target="menuPage">
            <span class="nav-icon">üìã</span>
            <span>Menu</span>
        </button>
        <button class="nav-item" data-target="ratingPage">
            <span class="nav-icon">‚≠ê</span>
            <span>Rate Food</span>
        </button>
        <button class="nav-item" data-target="statusPage">
            <span class="nav-icon">üìä</span>
            <span>Feedback Status</span>
        </button>
    </div>
</nav>

<!-- ========== MAIN CONTENT ========== -->
<main class="container">

    <!-- MENU SECTION -->
    <section id="menuPage" class="page-section active">
        <div class="card glass-card">
            <div class="section-header">
                <h2>üç¥ This Week's Menu</h2>
                <p class="muted">Special dishes are highlighted for the day</p>
            </div>
            <div id="menuGrid" class="menu-grid"></div>
        </div>
    </section>

    <!-- FEEDBACK FORM SECTION -->
    <section id="ratingPage" class="page-section">
        <div class="card glass-card">
            <div class="section-header">
                <h2>‚≠ê Rate Today's Food</h2>
                <p class="muted">Your feedback helps us serve you better</p>
            </div>

            <form id="feedbackForm" enctype="multipart/form-data" class="feedback-form">
                
                <div class="form-row">
                    <div class="form-group">
                        <label>
                            <span class="label-icon">üë§</span>
                            Full Name
                        </label>
                        <input type="text" name="name" required placeholder="Enter your name">
                    </div>

                    <div class="form-group">
                        <label>
                            <span class="label-icon">üìß</span>
                            Student Email
                        </label>
                        <input type="email" name="student_id" placeholder="your-email@college.edu" required>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>
                            <span class="label-icon">üìÖ</span>
                            Day
                        </label>
                        <select name="meal_day" required>
                            <option disabled selected>Select Day</option>
                            <option>Monday</option>
                            <option>Tuesday</option>
                            <option>Wednesday</option>
                            <option>Thursday</option>
                            <option>Friday</option>
                            <option>Saturday</option>
                            <option>Sunday</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>
                            <span class="label-icon">üçΩÔ∏è</span>
                            Meal Time
                        </label>
                        <select name="meal_time" required>
                            <option disabled selected>Select Meal</option>
                            <option>Breakfast</option>
                            <option>Lunch</option>
                            <option>Dinner</option>
                        </select>
                    </div>
                </div>

                <!-- Star Rating -->
                <div class="rating-section">
                    <label class="rating-label">
                        <span class="label-icon">‚≠ê</span>
                        Your Rating
                    </label>
                    <div class="stars">
                        <input type="radio" id="star5" name="rating" value="5" required>
                        <label for="star5" title="Excellent">‚òÖ</label>
                        
                        <input type="radio" id="star4" name="rating" value="4">
                        <label for="star4" title="Good">‚òÖ</label>
                        
                        <input type="radio" id="star3" name="rating" value="3">
                        <label for="star3" title="Average">‚òÖ</label>
                        
                        <input type="radio" id="star2" name="rating" value="2">
                        <label for="star2" title="Below Average">‚òÖ</label>
                        
                        <input type="radio" id="star1" name="rating" value="1">
                        <label for="star1" title="Poor">‚òÖ</label>
                    </div>
                </div>

                <!-- Meme Display -->
                <div id="memeDisplay" class="meme-display">
                    <img id="memeImage" alt="Reaction meme">
                    <p id="memeText">Select a rating to see the reaction! üòä</p>
                </div>

                <!-- Photo Upload -->
                <div class="form-group full-width">
                    <label>
                        <span class="label-icon">üì∏</span>
                        Attach Photo (Optional)
                    </label>
                    <div class="file-upload">
                        <input type="file" accept="image/*" name="image" id="imageInput">
                        <label for="imageInput" class="file-label">
                            <span class="upload-icon">üì§</span>
                            <span class="upload-text">Click to upload or drag & drop</span>
                        </label>
                    </div>
                </div>

                <!-- Comment Box -->
                <div class="form-group full-width">
                    <label>
                        <span class="label-icon">üí¨</span>
                        Your Feedback
                    </label>
                    <textarea name="comment" required placeholder="Share your thoughts about the food quality, taste, presentation..."></textarea>
                </div>

                <button class="submit-btn" type="submit">
                    <span>Submit Feedback</span>
                    <span class="btn-icon">‚Üí</span>
                </button>
                
                <div id="formMsg" class="form-msg"></div>
            </form>
        </div>
    </section>

    <!-- FEEDBACK STATUS SECTION -->
    <section id="statusPage" class="page-section">
        <div class="card glass-card">
            <div class="section-header">
                <h2>üìä Recent Feedback</h2>
                <p class="muted">Track your submitted feedback status</p>
            </div>
            <div id="recentList" class="recent-list"></div>
        </div>
    </section>

</main>

<!-- ========== FOOTER ========== -->
<footer class="site-footer">
    <div class="footer-content">
        <p>Made with <span class="heart">‚ù§Ô∏è</span> for better campus food experience</p>
        <p class="footer-sub">Simsang Hostel Mess Management System</p>
    </div>
</footer>

<!-- ========== JAVASCRIPT ========== -->
<script src="menu.js"></script>
<script>

/* ==========================================
   NAVIGATION SYSTEM
   ========================================== */
document.querySelectorAll(".nav-item").forEach(btn => {
    btn.addEventListener("click", () => {
        const target = btn.dataset.target;
        if (!target) return;

        // Update active states
        document.querySelectorAll(".nav-item").forEach(n => n.classList.remove("active"));
        btn.classList.add("active");

        // Show target section with fade animation
        document.querySelectorAll(".page-section").forEach(s => {
            s.classList.remove("active");
            s.style.animation = 'none';
        });
        
        const targetSection = document.getElementById(target);
        targetSection.classList.add("active");
        targetSection.style.animation = 'fadeInUp 0.5s ease';
    });
});

/* ==========================================
   RATING MEME SYSTEM
   ========================================== */
const memeMap = {
    5: { text: "Perfect! üëë Chef's Kiss!", imageUrl: "https://i.imgflip.com/ac9eyj.gif" },
    4: { text: "Very Good! üî• Almost perfect.", imageUrl: "https://i.imgflip.com/ac9ero.jpg" },
    3: { text: "Sometimes it's good, sometimes it's sh*t üòê", imageUrl: "https://i.imgflip.com/ac9dlr.jpg" },
    2: { text: "Bro‚Ä¶ seriously? üíÄ", imageUrl: "https://i.imgflip.com/ac9edm.jpg" },
    1: { text: "You get what you pay for... Never Again!! ü§¢", imageUrl: "https://i.imgflip.com/ac9e52.jpg" }
};

function updateMemeDisplay(e) {
    const val = e.target.value;
    const data = memeMap[val];
    const display = document.getElementById("memeDisplay");
    const img = document.getElementById("memeImage");
    const text = document.getElementById("memeText");

    if (data) {
        display.classList.add('show');
        img.src = data.imageUrl;
        img.style.display = "block";
        text.textContent = data.text;
    }
}

document.querySelectorAll('input[name="rating"]').forEach(r =>
    r.addEventListener("change", updateMemeDisplay)
);

/* ==========================================
   LOAD RECENT FEEDBACK
   ========================================== */
async function loadRecent() {
    try {
        const r = await fetch("fetch_feedback.php");
        const html = await r.text();
        document.getElementById("recentList").innerHTML = html || "<p class='no-data'>No feedback yet. Be the first to share!</p>";
    } catch {
        document.getElementById("recentList").innerHTML = "<p class='error'>Error loading feedback.</p>";
    }
}
loadRecent();

/* ==========================================
   FEEDBACK FORM SUBMISSION - FIXED
   Prevents duplicate submissions
   ========================================== */
let isSubmitting = false;

const feedbackForm = document.getElementById("feedbackForm");
if (feedbackForm) {
    feedbackForm.addEventListener("submit", async function(e) {
        e.preventDefault();
        e.stopPropagation();
        
        // Prevent double submission
        if (isSubmitting) {
            return false;
        }
        
        isSubmitting = true;
        
        const formMsg = document.getElementById("formMsg");
        const submitBtn = this.querySelector('button[type="submit"]');
        
        if (submitBtn) {
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="loader"></span> Submitting...';
        }
        
        const formData = new FormData(this);
        
        // Save user info
        const userEmail = formData.get('student_id');
        const userName = formData.get('name');
        
        if (userEmail) localStorage.setItem('user_email', userEmail);
        if (userName) localStorage.setItem('user_name', userName);
        
        try {
            const response = await fetch("feedback.php", {
                method: "POST",
                body: formData
            });
            
            const result = await response.json();
            
            if (result.success) {
                // Show success toast
                if (typeof showToast !== 'undefined') {
                    showToast(
                        'üéâ Feedback Submitted Successfully!',
                        'We\'ll review your feedback and notify you of updates.',
                        'success'
                    );
                }
                
                // Show status notification
                if (typeof showFeedbackNotification !== 'undefined') {
                    setTimeout(() => {
                        showFeedbackNotification(
                            'Pending',
                            'Your feedback has been received and is pending review.',
                            result.id || Date.now()
                        );
                    }, 1500);
                }
                
                // Reset form
                this.reset();
                
                // Reset meme display
                const memeDisplay = document.getElementById('memeDisplay');
                if (memeDisplay) {
                    memeDisplay.classList.remove('show');
                    const memeImage = document.getElementById('memeImage');
                    if (memeImage) memeImage.style.display = 'none';
                    const memeText = document.getElementById('memeText');
                    if (memeText) memeText.textContent = 'Select a rating to see the reaction! üòä';
                }
                
                // Reload recent feedback
                setTimeout(() => loadRecent(), 1000);
                
                formMsg.className = 'form-msg success';
                formMsg.textContent = '‚úÖ Feedback submitted successfully!';
                
                // Clear message after 5 seconds
                setTimeout(() => {
                    formMsg.textContent = '';
                    formMsg.className = 'form-msg';
                }, 5000);
                
            } else {
                formMsg.className = 'form-msg error';
                formMsg.textContent = '‚ùå ' + (result.error || 'Submission failed');
            }
        } catch (error) {
            console.error('Submission error:', error);
            formMsg.className = 'form-msg error';
            formMsg.textContent = '‚ùå Network error. Please try again.';
        } finally {
            // Re-enable after 2 seconds
            setTimeout(() => {
                isSubmitting = false;
                if (submitBtn) {
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = '<span>Submit Feedback</span><span class="btn-icon">‚Üí</span>';
                }
            }, 2000);
        }
        
        return false;
    });
}

/* ==========================================
   FILE UPLOAD PREVIEW
   ========================================== */
const fileInput = document.getElementById('imageInput');
if (fileInput) {
    fileInput.addEventListener('change', function() {
        if (this.files && this.files[0]) {
            const fileName = this.files[0].name;
            const label = this.nextElementSibling;
            label.querySelector('.upload-text').textContent = `‚úì ${fileName}`;
            label.style.borderColor = '#10b981';
            label.style.background = 'rgba(16, 185, 129, 0.05)';
        }
    });
}

/* ==========================================
   NOTIFICATION SYSTEM
   ========================================== */

// Get today's day name
function getTodayDay() {
    const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
    return days[new Date().getDay()];
}

// Session-based tracking
function isNotificationShownThisSession(notificationId) {
    const sessionNotifications = sessionStorage.getItem('shown_notifications');
    if (!sessionNotifications) return false;
    const shown = JSON.parse(sessionNotifications);
    return shown.includes(notificationId);
}

function markNotificationAsShown(notificationId) {
    let sessionNotifications = sessionStorage.getItem('shown_notifications');
    let shown = sessionNotifications ? JSON.parse(sessionNotifications) : [];
    if (!shown.includes(notificationId)) {
        shown.push(notificationId);
        sessionStorage.setItem('shown_notifications', JSON.stringify(shown));
    }
}

// Display today's menu
// Display today's menu - WAIT FOR MENU TO LOAD
function showTodaysMenu() {
    const today = getTodayDay();
    const todayMenuText = document.getElementById('todayMenuText');
    const banner = document.getElementById('todayMenuBanner');
    
    // Check if MENU is loaded
    if (typeof MENU === 'undefined' || Object.keys(MENU).length === 0) {
        todayMenuText.textContent = 'Loading menu...';
        // Retry after 1 second
        setTimeout(showTodaysMenu, 1000);
        return;
    }
    
    if (MENU[today]) {
        const meals = [];
        for (const mealTime in MENU[today]) {
            const meal = MENU[today][mealTime];
            const items = meal.items.slice(0, 3).join(', ');
            const hasMore = meal.items.length > 3 ? '...' : '';
            meals.push(`${mealTime}: ${items}${hasMore}`);
        }
        todayMenuText.textContent = meals.join(' | ');
        if (banner) {
            banner.style.display = 'block';
            banner.style.animation = 'slideInDown 0.5s ease';
        }
    } else {
        todayMenuText.textContent = 'Menu for ' + today + ' not available';
    }
}


// Close banner
function closeBanner(bannerId) {
    const banner = document.getElementById(bannerId);
    if (banner) {
        banner.style.animation = 'slideOutUp 0.3s ease';
        setTimeout(() => {
            banner.style.display = 'none';
        }, 300);
        markNotificationAsShown(bannerId);
    }
}

// Show feedback notification
function showFeedbackNotification(status, message, feedbackId) {
    const banner = document.getElementById('feedbackBanner');
    const title = document.getElementById('feedbackStatusTitle');
    const text = document.getElementById('feedbackStatusText');
    
    if (banner && title && text) {
        const statusMessages = {
            'Pending': { title: 'üìã Feedback Received' },
            'Viewed': { title: 'üëÄ Feedback Under Review' },
            'Resolved': { title: '‚úÖ Feedback Resolved' }
        };
        
        const statusData = statusMessages[status] || statusMessages['Pending'];
        title.textContent = statusData.title;
        text.textContent = message;
        banner.className = `notification-banner feedback-notification ${status.toLowerCase()}`;
        banner.style.display = 'block';
        banner.style.animation = 'slideInDown 0.5s ease';
        
        setTimeout(() => closeBanner('feedbackBanner'), 12000);
        markNotificationAsShown('feedback_' + feedbackId + '_' + status);
    }
}

// Show toast
function showToast(title, message, type = 'success') {
    const toast = document.createElement('div');
    toast.className = `toast-notification ${type}`;
    const icons = { success: '‚úÖ', info: '‚ÑπÔ∏è', warning: '‚ö†Ô∏è', error: '‚ùå' };
    toast.innerHTML = `
        <span class="toast-icon">${icons[type]}</span>
        <div class="toast-content">
            <div class="toast-title">${title}</div>
            <div class="toast-message">${message}</div>
        </div>
    `;
    document.body.appendChild(toast);
    setTimeout(() => toast.classList.add('show'), 10);
    setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => toast.remove(), 400);
    }, 5000);
}

// Check feedback status
async function checkUserFeedbackStatus() {
    const userEmail = localStorage.getItem('user_email');
    if (userEmail) {
        try {
            const response = await fetch(`check_feedback_status.php?email=${encodeURIComponent(userEmail)}`);
            const data = await response.json();
            if (data.success && data.latest_feedback) {
                const feedback = data.latest_feedback;
                const notificationId = 'feedback_' + feedback.id + '_' + feedback.status;
                if (!isNotificationShownThisSession(notificationId)) {
                    setTimeout(() => {
                        showFeedbackNotification(feedback.status, data.message, feedback.id);
                    }, 2000);
                }
            }
        } catch (error) {
            console.log('Could not check feedback status:', error);
        }
    }
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    showTodaysMenu();
    checkUserFeedbackStatus();
    setInterval(checkUserFeedbackStatus, 30000);
});

// Add slide out animation
const style = document.createElement('style');
style.textContent = `
    @keyframes slideOutUp {
        from { opacity: 1; transform: translateY(0); }
        to { opacity: 0; transform: translateY(-30px); }
    }
`;
document.head.appendChild(style);

</script>

</body>
</html>
